{% extends 'deliveryagent/base1.html' %}
{% load static %}
{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="https://www.bing.com/api/maps/mapcontrol?key=Agyr0UQGWTFzP3Fwb3PDJ_ahP24jx9jRgpUWwBD_37B8MXu1oql6WCs6J-vgU1YT"></script>


  {% if deliveryagent.is_approved == 'updated' %}
  <div class="row">
    <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-9">
              <div class="d-flex align-items-center align-self-start">
                <h3 class="mb-0">Status</h3>
                {% if deliveryagent.availability == 'available' %}
                <p class="text-success ml-2 mb-0 font-weight-medium">Available</p>
                {% else %}
                <p class="text-Danger ml-2 mb-0 font-weight-medium">Unavailable</p>
                {% endif %}  
              </div>
            </div>
            <div class="col-3">
              <div class="icon icon-box-success ">
                {% if deliveryagent.availability == 'available' %}
                <span class="mdi mdi-briefcase-check icon-item"></span>
                {% else %}
                <span class="mdi mdi-briefcase icon-item"></span>
                {% endif %}  
              </div>
            </div>
          </div>
         
          {% if deliveryagent.availability == 'available' %}
          <form method="post" action="{% url 'status_unavailable' deliveryagent.id %}">
            {% csrf_token %}
          <button class="btn btn-outline-light btn-fw" type="submit">Change Status</button>
          </form>
          {% else %}
          <form method="post" action="{% url 'status_available' deliveryagent.id %}">
            {% csrf_token %}
          <button class="btn btn-outline-light btn-fw" type="submit">Change Status</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-9">
              <div class="d-flex align-items-center align-self-start">
                <h3 class="mb-0">{{ orderitem_count }}</h3>
                <p class="text-light ml-2 mb-0 font-weight-medium">orders</p>
              </div>
            </div>
            <div class="col-3">
              <div class="icon icon-box-success">
                <span class="mdi mdi-crosshairs-gps icon-item"></span>
              </div>
            </div>
          </div>
          <h6 class="text-muted font-weight-normal">Total</h6>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-9">
              <div class="d-flex align-items-center align-self-start">
                <h3 class="mb-0">{{orderitem_delivered_count}}</h3>
                <p class="text-success ml-2 mb-0 font-weight-medium">orders</p>
              </div>
            </div>
            <div class="col-3">
              <div class="icon icon-box-success">
                <span class="mdi mdi-arrow-top-right icon-item"></span>
              </div>
            </div>
          </div>
          <h6 class="text-muted font-weight-normal">Delivered</h6>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-9">
              <div class="d-flex align-items-center align-self-start">
                <h3 class="mb-0">{{orderitem_pending_count}}</h3>
                <p class="text-danger ml-2 mb-0 font-weight-medium">orders</p>
              </div>
            </div>
            <div class="col-3">
              <div class="icon icon-box-danger ">
                <span class="mdi mdi-arrow-bottom-left icon-item"></span>
              </div>
            </div>
          </div>
          <h6 class="text-muted font-weight-normal">Pending</h6>
        </div>
      </div>
    </div>
  </div>
  {% comment %} <div class="row">
    <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-9">
              <div class="d-flex align-items-center align-self-start">
                <h3 class="mb-0">$12.34</h3>
                <p class="text-success ml-2 mb-0 font-weight-medium">+3.5%</p>
              </div>
            </div>
            <div class="col-3">
              <div class="icon icon-box-success ">
                <span class="mdi mdi-arrow-top-right icon-item"></span>
              </div>
            </div>
          </div>
          <h6 class="text-muted font-weight-normal">Potential growth</h6>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-9">
              <div class="d-flex align-items-center align-self-start">
                <h3 class="mb-0">$17.34</h3>
                <p class="text-success ml-2 mb-0 font-weight-medium">+11%</p>
              </div>
            </div>
            <div class="col-3">
              <div class="icon icon-box-success">
                <span class="mdi mdi-arrow-top-right icon-item"></span>
              </div>
            </div>
          </div>
          <h6 class="text-muted font-weight-normal">Revenue current</h6>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-9">
              <div class="d-flex align-items-center align-self-start">
                <h3 class="mb-0">$12.34</h3>
                <p class="text-danger ml-2 mb-0 font-weight-medium">-2.4%</p>
              </div>
            </div>
            <div class="col-3">
              <div class="icon icon-box-danger">
                <span class="mdi mdi-arrow-bottom-left icon-item"></span>
              </div>
            </div>
          </div>
          <h6 class="text-muted font-weight-normal">Daily Income</h6>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-9">
              <div class="d-flex align-items-center align-self-start">
                <h3 class="mb-0">$31.53</h3>
                <p class="text-success ml-2 mb-0 font-weight-medium">+3.5%</p>
              </div>
            </div>
            <div class="col-3">
              <div class="icon icon-box-success ">
                <span class="mdi mdi-arrow-top-right icon-item"></span>
              </div>
            </div>
          </div>
          <h6 class="text-muted font-weight-normal">Expense current</h6>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-4 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Transaction History</h4>
          <canvas id="transaction-history" class="transaction-chart"></canvas>
          <div class="bg-gray-dark d-flex d-md-block d-xl-flex flex-row py-3 px-4 px-md-3 px-xl-4 rounded mt-3">
            <div class="text-md-center text-xl-left">
              <h6 class="mb-1">Transfer to Paypal</h6>
              <p class="text-muted mb-0">07 Jan 2019, 09:12AM</p>
            </div>
            <div class="align-self-center flex-grow text-right text-md-center text-xl-right py-md-2 py-xl-0">
              <h6 class="font-weight-bold mb-0">$236</h6>
            </div>
          </div>
          <div class="bg-gray-dark d-flex d-md-block d-xl-flex flex-row py-3 px-4 px-md-3 px-xl-4 rounded mt-3">
            <div class="text-md-center text-xl-left">
              <h6 class="mb-1">Tranfer to Stripe</h6>
              <p class="text-muted mb-0">07 Jan 2019, 09:12AM</p>
            </div>
            <div class="align-self-center flex-grow text-right text-md-center text-xl-right py-md-2 py-xl-0">
              <h6 class="font-weight-bold mb-0">$593</h6>
            </div>
          </div>
        </div>
      </div>
    </div> {% endcomment %}
<div class="row">
  <div class="col-md-8 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <div class="d-flex flex-row justify-content-between">
          <h4 class="card-title mb-1">Reviews</h4>
          {% with avg_rating_rounded=avg_rating|default:0|floatformat:"0" %}
            {% for i in "12345" %}
              {% if i <= avg_rating_rounded %}
                  <small class="mdi mdi-star text-light" ></small>
                  {% else %}
                  <h4 class="card-title mb-1 mdi mdi-star text-dark" ></h4>
                  {% endif %}
            {% endfor %}
          {% endwith %}
         
          <p class="text-muted mb-1">Reviews for  {{ deliveryagent.name }}</p>
        </div>
        <div class="row" id="reviewssection">
          <div class="col-12">
            <div class="preview-list">
              {% for review in allreviews %}
              <div class="preview-item border-bottom">
                {% with review_rating=review.rating|stringformat:"d"|default:0 %}
                <div class="preview-thumbnail">
                  <div class="preview-icon ">
                    {% if review.user.userprofile.profile_pic %}
                    <img src="{{ review.user.userprofile.profile_pic.url }}" alt="image" class="rounded-circle" />
                    {% else %}
                    <img src="{% static 'images/usericon.png' %}" alt="image" class="rounded-circle" />
                    {% endif %}
                  </div>
                </div>
                
                <div class="preview-item-content d-sm-flex flex-grow ">
                  <div class="flex-grow">
                    <h6 class="preview-subject">{{ review.description }}</h6>
                    <p class="text-muted mb-0">{{ review.user.userprofile.name }}</p>
                    <div class="mr-auto text-sm-right">
                      {% for i in "12345" %}
                      {% if i <= review_rating %}
                          <small class="mdi mdi-star text-light" ></small>
                      {% else %}
                          <small class="mdi mdi-star text-dark" ></small>
                      {% endif %}
                      
                      {% endfor %}
                    </div>
                  </div>
                 
                </div>
                {% endwith %}
              </div>
              {% empty %}
              <div class="preview-item border-bottom">
                <h4 class="card-title mb-1">No reviews available</h4>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>
  {% comment %} <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Visitors by Countries</h4>
          <div class="row">
            <div class="col-md-12">
              
                <div class="map" id="myMap" style="height: 400px"></div>
            
            </div>
          </div>
        </div>
      </div>
    </div>
     {% endcomment %}
  {% else %}
<div class="row">
  <div class="col-12 grid-margin">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Profile Updation</h4>
        <form class="form-sample" method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
          {% csrf_token %}
          <p class="card-description"> Basic info </p>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group row">
                <label class="col-sm-3 col-form-label"  for="owner_name">Agent Name</label>
                <div class="col-sm-9">
                  <input type="text" id="owner_name" value="{{ user.userprofile.name }}"  name="owner_name" class="form-control" style="background-color:#2A3038;" readonly>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="email">Email</label>
                <div class="col-sm-9">
                  <input type="text"  id="email" value="{{ user.userprofile.email }}"  name="email" style="background-color:#2A3038;"  class="form-control" readonly>
                </div>
              </div>
            </div>
          </div>
          <p class="card-description"> Delivery info </p>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="availability">Availability</label>
                <div class="col-sm-9">
                  <select class="form-control" name="availability" id="availability" required>
                    <option value="available">Available</option>
                    <option value="not_available">Not Available</option>
                  </select>
                  <span id="availability_error" class="text-danger"></span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="vehicletype">Vehicle Type</label>
                <div class="col-sm-9">
                  <select class="form-control" id="vehicle_type" name="vehicle_type" required>
                   
                    <option value="car">Car</option>
                  
                    <option value="car">Pick-up</option>
                </select>
                  <span id="vehicletype_error" class="text-danger"></span>
              </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group row">
                <label class="col-sm-3 col-form-label" for="license">Licence Number</label>
                <div class="col-sm-9">
                  <input type="text" class="form-control" id="license" name="license" >
                  <span id="license_error" class="text-danger"></span>
              </div>
              </div>
            </div>
          </div>
          <p class="card-description"> Location </p>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group row">
                <label for="latitude" class="col-sm-3 col-form-label">Latitude</label>
                <div class="col-sm-9">
                  <input type="text" id="lat" name="latitude" class="form-control" required>
                  <span id="latspan" class="text-danger"></span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group row">
                <label for="longitude" class="col-sm-3 col-form-label">Longitude</label>
                <div class="col-sm-9">
                  <input type="text" id="long" name="longitude"  class="form-control" required>
                  <span id="longspan" class="text-danger"></span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group row">
                <button type="button" onclick="getCoordinates()" class="btn btn-dark btn-sm">Get Coordinates</button>
              </div>
            </div>
          </div>
          <p class="card-description"> Upload section </p>
          <div class="row">
            
            <div class="col-md-12">
              <div class="form-group row">
                <label for="profile_pic" class="col-sm-3 col-form-label">Profile Picture</label>
                <div class="col-sm-9">
                  <input type="file" class="form-control" id="profile_pic" name="profile_pic" accept="image/*" >
                  <span id="profile_pic_error" class="text-danger"></span>
                </div>
              </div>
            </div>
          </div>
          <button type="submit" class="btn btn-primary mr-2">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>  

{% endif %}
  <script>
    
    $(document).ready(function () {
      $("#profile_pic").change(function () {
          validateCertificationImage("#profile_pic");
      });

      $("#lat").change(function () {
          validatelat();
      });
  
      $("#long").change(function () {
          validatelong();
      });

      $("#license").change(function () {
        validatelicence();
      });

        $("#vehicle_type").change(function () {
          validatevehtype();
      });

      $("#availability").change(function () {
        validateavailability();
      });

      
  });
    
     

      function validateCertificationImage(fieldId) {
        var certificationImage = $(fieldId)[0].files[0];
        var certificationImageError = $("#profile_pic_error");
        
        if (!certificationImage) {
            certificationImageError.html("Profile Picture is required").css("color", "red");
        } else {
            var validImageTypes = ["image/jpeg", "image/png"]; // Add more types if needed
    
            if (validImageTypes.indexOf(certificationImage.type) === -1) {
                certificationImageError.html("Invalid image format. Only JPEG and PNG allowed.").css("color", "red");
            } else {
                certificationImageError.html("").css("color", "red");
            }
        }
    }
    

    
      function validatelat() {
        var latitude = $("#lat").val().trim();
        var latError = $("#latspan");
        var latPattern = /^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/; // Regex for latitude
    
       if (!latPattern.test(latitude)) {
            latError.html("Invalid latitude format").css("color", "red");
        } else {
            latError.html("").css("color", "red");
        }
    }
    
    function validatelong() {
        var longitude = $("#long").val().trim();
        var longError = $("#longspan");
        var longPattern = /^[-+]?(180(\.0+)?|((1[0-7]\d)|(\d{1,2}))(\.\d+)?)$/; // Regex for longitude
    
        if (!longPattern.test(longitude)) {
            longError.html("Invalid longitude format").css("color", "red");
        } else {
            longError.html("").css("color", "red");
        }
    }
    function validatelicence() {
      var license = $("#license").val().trim();
      var licenseError = $("#license_error");
      var licensePattern = /^[A-Za-z]{2}\d{13}$/; // Regex for Indian license number
      
      if (!licensePattern.test(license)) {
          licenseError.html("Invalid Indian license number format. It should consist of 2 letters followed by 13 digits.").css("color", "red");
      } else {
          licenseError.html("").css("color", "red");
      }
  }
  
  
  function validatevehtype() {
      var vehicleType = $("#vehicle_type").val();
      var vehicleTypeError = $("#vehicletype_error");
      
      if (vehicleType === null || vehicleType === "") {
          vehicleTypeError.html("Please select a vehicle type").css("color", "red");
      } else {
          vehicleTypeError.html("").css("color", "red");
      }
  }
  
  function validateavailability() {
      var availability = $("#availability").val();
      var availabilityError = $("#availability_error");
      
      if (availability === null || availability === "") {
          availabilityError.html("Please select availability").css("color", "red");
      } else {
          availabilityError.html("").css("color", "red");
      }
  }
    function validateForm() {
      // Check if there are any validation errors
      const errorElements = $(".text-danger");
      for (const errorElement of errorElements) {
          if ($(errorElement).html() !== "") {
              return false; // Prevent form submission if there are validation errors
          }
      }
  
      return true; // Submit the form if there are no validation errors
  }
      function getCoordinates() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }
  
      function showPosition(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
      
        // Populate the latitude and longitude input fields with the obtained values
        document.getElementById('lat').value = latitude;
        document.getElementById('long').value = longitude;
      }
  </script>
  <style>
    #reviewssection {
      height: 400px; /* Set the fixed height */
      overflow-y: auto; /* Enable vertical scrollbar if content exceeds the height */
     /* Add border for better visibility */
    }

    /* Optional: Add styling for slider controls */
    #reviewssection::-webkit-scrollbar {
      width: 5px;
    }

    #reviewssection::-webkit-scrollbar-thumb {
      background-color: #888;
      border-radius: 5px;
    }
  </style>
    {% endblock %}

